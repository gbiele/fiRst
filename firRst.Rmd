---
title: "A first R anaysis"
author: "Guido Biele"
date: "16 november 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This document aims to povide a shirt introduction into statistical analysis with R. The assumption is, that the reader is already familiar with basic concepts in R and the Rstuido IDE, and has some basic knowledge about statistics, for example from using SPSS. The goal here is to show how one can

* open an SPSS file
* merge seperate data sets
* visually inspect the data
* do a simple data reduction through an explatory factor analysis
* estimate the association between an exposure and an outcome with a linear regregssion
* visualize the results of this regression.

## Packages

The name R refers at the same time to 3 things:

1. A programming language
2. A software for statistical analyses
3. An ecosystem of _packages_ that implement different statistical analyses.

R packages are written (typically by using R, the programming language) by researchers and available for free. These packages are crucial, because the capabilities of The basic R software are limited.

There are thousands of R packages. Therefore, CRAN [task view web sites](https://cran.rstudio.com/web/views/) are usful to give an overview about R packages for different application areas. CRAN stands for "Comprehensive R Archive Network".


For this introduction we will use following packes:

* `haven` allows to read SPSS (or stata) data into R
* `ggplot` facilitates plotting 
* `psych` is a package for factor analysis and related things
* `sjPlot` makes plotting of regression analysis results easy

Installing packages is easy!

```{r, eval=FALSE}
install.packages("haven")
install.packages("ggplot2")
install.packages("psych")
install.packages("sjplot")
install.packages("VIM")
```

One can also install multiple packages simulataneously as follows `install.packages(c("haven","psych"))`.

## Loading data

The problem we are looking at is the association between Parenting Style and child mental health symptoms. More specifically, we look at the association between self reported Parenting Style of well educated Norwegian mothers at child age 5 years and opposional behavior as well as mood and feeling at age 8. This data can be obtained from moba questionnaires 5 and 8.

If these data are available in SPSS (or stata) format, we can read them with the `haven` package, which we wirst have to load befor we can use it:

```{r}
library(haven)
library(VIM)
library(data.table)
```

All packages comn with a documentation, and if one is lucky also with one or more _vignettes_, which are tutorial-style documents that show how the functions in the package can be used. This and more information about the packages can be found at https://cran.rstudio.com/web/packages/haven/. For other packages, just replace "haven" with the name of the package you are interested in.


OK, now we can load the data:
```{r, eval = F}
data_directory = "data/"
Q5aar = read_sav(paste0(data_directory,
                        "PDB439_Skjema5aar_v10.sav"))
Q5aar = data.frame(Q5aar)
```

So what have we done here?
We first created a new variable `data_directory` and set it to the path to the directory where the data files are. Then, when loading the data into the data.frame `Q5aar`, we collated the path to the directory with the name of the data file by using the `paste0`command.

The reason for doing this is that the code becomes a bit easier to read (still not great ). For the same reason, I made a line break at the end of `Q5aar = read_sav(paste0(data_directory,`.

Note that if we would already be in the same directory as the data file, we could just have written `Q5aar = read_sav("PDB439_Skjema5aar_v10.sav")`. You can use the commands `getwd()` and `setwd()` to check and set you working directory (wd).

Next we select the variables we need. This are the pregancy ID and the child number, as well as the items for measuring parental style (we get SPSS variable names from [here](https://www.fhi.no/globalassets/dokumenterfiler/studier/moba/dokumenter/instrument-documentation-q-5year.pdf)). 

```{r, eval = F}
Q5aar = Q5aar[,c("PREG_ID_439","BARN_NR",
                 paste0("LL",526:534))]
names(Q5aar)
```

```{r, echo=F}
load("data/Q5aar.Rdata")
names(Q5aar)
```


Ok, these variable names are not very clear, lets rename them:

```{r}
names(Q5aar)[3:11] = paste0("PS.item.",1:9)
names(Q5aar)
```

It is important to understan the coding of the variables. The haven package makes SPSS' _Variable label_ and _Value label_ information available as attributes of the variables in the data.frame. We can access those as follows:

```{r}
attr(Q5aar$PS.item.1,"label")
attr(Q5aar$PS.item.1,"labels")
```

Here we see one anoying detail of SPSS Moba data: If the mother has ticked more than one box, the data are for our purposes missing, and not zero. We need to fix that.

To do this, we do a quick for loop:

```{r}
item_levels = attr(Q5aar$PS.item.1,"lables")[-1]
item_names = names(Q5aar)[-c(1,2)]
item_quest = c()
for (v in item_names) {
  item_quest = c(item_quest,
                 strsplit(attr(Q5aar[,v],"label"),
                          split = ";")[[1]][2])
  attr(Q5aar[, v],"labels") = attr(Q5aar[, v],"labels")[-1]
  # need to use the "which", otherwise R stumbles over missing values
  value_is_0 = which(Q5aar[,v] == 0)
  Q5aar[value_is_0, v] = NA
}
table(as_factor(Q5aar$PS.item.1))
table(addNA(as_factor(Q5aar$PS.item.1)))
```

There is lots of missing data, probably because MoBa changed the Parenting Style items throughout.

Lets look a little closer at the missing data:

```{r}
is_missing = is.na(Q5aar[,-c(1,2)])
hist(rowSums(is_missing))
```

Indeed there is a substantial number of cases for which als Parenting style itmes are missing. Let's remove those participants. In fact, to facilitate any further analysis, we'll only use the complete cases.
```{r}
Q5aar = Q5aar[complete.cases(Q5aar),]
```


## A quick exploratory factor analysis of parenting style items in MoBa

Out goal is to reduce the 9 items to a smaller set of variables describing parenting style. One way to do this is to use exploratory factor analysis (EFA) to learn the factor structure of the data. As a first step we'll check how many factors we need, using the `fa.parallel.poly` command from the `psych` package. As with many things in R, using up to date methods is not hard, as you'll see. The problem is more in knowing that these methods exist. If you do not know which method to use, try googling it!

One thing we need to specify is that polychoric correlations are used, because we have ordinal data.

```{r}
library(psych)
describe(Q5aar[,-c(1,2)])
fa.parallel(Q5aar[,-c(1,2)], cor = "poly")
```

4 factors. I had hoped fewer, but lets continue and do an exploratory factor analysis.

```{r}
fa_ps = fa(Q5aar[,-c(1,2)],
           nfactors = 4, 
           cor = "poly")
fa_ps
```

We can at first look at the RMSEA. The cvalue is 0.01, which is vary good. however, we also see that factors 1, 3 and 4 have high correlations with each other. lets try with only 2 fatcors.

```{r}
fa_ps = fa(Q5aar[,-c(1,2)],
           nfactors = 2, 
           cor = "poly")
fa_ps
```

This are the factor loadings: 

```{r}
factor_loadings = loadings(fa_ps)
par(mar = c(5,3,1,1))
xs = barplot(t(factor_loadings),
             beside = T, 
             xaxt = "n")
axis(1,
     at = colMeans(xs),
     labels = paste0("Item\n",1:9), lty = 0)
```

This is pretty clear, in that there are no items that have a high loading for both factors. To understand the factors, we look at the associated items.

```{r}
simple_loadings = apply(factor_loadings,
                        1,
                        function(x)
                          (abs(x) == max(abs(x))))
items_factor1 = which(simple_loadings[1,] == T)
items_factor2 = which(simple_loadings[2,] == T)

cat("FACTOR 1 \n")
cat(paste(item_quest[items_factor1],
          collapse = "\n"))

cat("\n\nFACTOR 2 \n")
cat(paste(item_quest[items_factor2],
          collapse = "\n"))
```


This looks as if there is one factor around positive reinforcement and communication with the child. Lets call this _positive parenting_. The other factor appears to be about the inability to follow through with threats of punishment, lets call this _bla bla parenting_ ;-). If we scroll back and look at correlation of the two factors, it looks as if _positive parenting_ is associated with the abaility to follow through with threats.


Now, if we want to use the parenting dimensions as predictors, we need to extract the factor scores. Factor scores are likely stored in the `fa_ps` object, which has the results of out exploratory factor analysis. If we want to know what this object contains, we can simply click on in in the "Environment" tab at the right hand side of the RStudio IDE.

```{r}
factor_scores = fa_ps$scores
colnames(factor_scores) = c("positive","blabla")
```

Lets quickly look at the factor scores, before we add them to the data.frame with teh 5 year data.:

```{r}
par(mfrow = c(1,2))
hist(factor_scores[,1],
     breaks = 25,
     main = "positive")
hist(factor_scores[,2],
     breaks = 25,
     main = "bla bla")
Q5aar = cbind(Q5aar,factor_scores)

```

If we had a great parenting scale, the histograms should look normally distributed. Especially the histogram for positive parenting deviates from that. It shows that (a) there are a few extreme outliers to the left and (b) there seems to be someting like a ceiling effect. That is, a good number of mothers report to be **VERY** positive in their parenting. This is another instance wehre it would be great to have a social desirability scale in MoBa.

Anyhow, lets continue and put together outcome data.
For this, we load the MoBa 8 years data file.

```{r, eval = F}
data_directory = "data/"
Q8aar = read_sav(paste0(data_directory,
                        "PDB439_Skjema8aar_v10.sav"))
Q8aar = Q8aar[,c("PREG_ID_439","BARN_NR",
                 paste("NN",c(68:80,        # SMFQ
                              211:226,      # CCC-2 sort
                              227:233, 374, # Språåk 20
                              111:118,      # CD
                              119:136,      # ADHD
                              137:144),     # OD
                       sep = ""))]

Q8aar = data.frame(Q8aar)
```

```{r, echo=F}
load("data/Q8aar.Rdata")
```

Now we are coming to a part, which always takes more time than we would wish: cleaning the data. We wqant to calculate sum-scores, but this is compliated by two facts: MoBa data come with 

* `0` instead of `NA` for data with unambiguous responses
* all scales start at 1
* some of the data are missing.

We will adress these problems in that order, starting with renaming some variables. To make this easier, we'll create simple functions where this is useful.

First we ranme all variables:

```{r}

rename_variables = function(df,old_names,new_names) {
  names(df)[names(df) %in% old_names] = new_names
  return(df)
}

Q8aar = rename_variables(Q8aar,
                         paste0("NN",68:80),
                         paste0("SMFQ.i",1:13,"_8y"))
Q8aar = rename_variables(Q8aar,
                         paste0("NN",c(227:233,374)),
                         paste0("SPRAAK20.i",1:8,"_8y"))
Q8aar = rename_variables(Q8aar,
                         paste0("NN",211:226),
                         paste0("CCCs.i",1:16,"_8y"))
for (item in paste0("CCCs.i",c(10:16),"_8y")) 
  Q8aar[,item] = abs(Q8aar[,item]-5)
Q8aar = rename_variables(Q8aar,
                         paste0("NN",111:118),
                         paste0("CD.i",1:8,"_8y"))
Q8aar = rename_variables(Q8aar,
                         paste0("NN",119:136),
                         paste0("ADHD.i",1:18,"_8y"))
Q8aar = rename_variables(Q8aar,
                         paste0("NN",137:144),
                         paste0("OD.i",1:8,"_8y"))
Q8aar = rename_variables(Q8aar,
                         paste0("NN",145:149),
                         paste0("SCARED.i",1:5,"_8y"))
```

Next we replace all 0 values with NA and subtract 1 from all items. We use the `grep` command, which makes it easy for us to find all variables that match a particular pattern. We also temporarily create a new `data.frame` tmp_items, in which we keep the item data. 

```{r}
all_items = grep("\\.i[0-9]",names(Q8aar), value = T)
tmp_items = Q8aar[,all_items]
tmp_items[tmp_items == 0] = NA
tmp_items = tmp_items-1
```

Now we need to make sum scores. Lets see, if there are any missing data:

```{r}
colSums(is.na(tmp_items))
```


There are mssing data. We can use imputation to replace missing data. I prefer to do this only for cases, for which we have at least 50% of the data. So we remove participants with more than 50% missing data.

```{r}
proportion_missing = rowMeans(is.na(tmp_items))
Q8aar = Q8aar[proportion_missing < .5,]
tmp_items = tmp_items[proportion_missing < .5,]
```

Now we use the function `hotdeck`from the package `VIM` to do a k-nearest neighbourgh imputation. (`hotdeck` is fast). Other approaches like nearest neigbourg imputation of multiple chained imputation are more accurate, by they are to slow when analysing bigger data-sets in a turorial.

```{r}
tmp_items_imputed = hotdeck(as.matrix(tmp_items))
tmp_items_imputed = tmp_items_imputed[,1:ncol(tmp_items)]
```

Finally, we can calculate sum scores.

```{r}
scales = c("OD","ADHD","CD","SMFQ","CCC","SPRAAK")
sum_scores = matrix(NA,
                    nrow = nrow(Q8aar),
                    ncol = length(scales))
colnames(sum_scores) = scales
par(mfrow = c(2,3))
for (s in scales) {
  items = grep(s,names(tmp_items_imputed), value = T)
  sum_scores[,s] = rowSums(tmp_items_imputed[,items])
  hist(sum_scores[,s],
       main = s,
       ylab = "")
}
head(sum_scores)
```

This looks more or less as expected. Now we put the Q8aar data together, and merge 5 and 8 years data.

```{r}
Q8aar = cbind(Q8aar, sum_scores)
my_data = merge(Q5aar[,c("PREG_ID_439","BARN_NR",colnames(factor_scores))],
                Q8aar[,c("PREG_ID_439","BARN_NR",scales)])
head(my_data)
my_data$positive = scale(my_data$positive)
my_data$blabla = scale(my_data$blabla)
my_data = my_data[my_data$positive > -4,]
```

Finally, we can do simple linear regression models:
```{r}
summary(lm(OD ~positive + blabla,my_data))
```

